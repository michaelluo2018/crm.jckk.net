{extend name="layout"/}
{block name="title"/}
    <title>添加项目 - 客户管理系统</title>
{/block}
{block name="js"/}
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
{/block}
{block name="breadcrumb"/}
    <div class="col-md-5 col-8 align-self-center">
                    <h3 class="text-themecolor">工作台</h3>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">首页</a></li>
                        <li class="breadcrumb-item go_back"><a href="javascript:void(0)">项目管理</a></li>
                        <li class="breadcrumb-item active">添加项目</li>
                    </ol>
                </div>
 {/block}
{block name="detail"/}
    <div class="row">
        <div class="col-lg-12">
            <div class="card card-outline-info">
                <div class="card-header">
                    <h4 class="m-b-0 text-white">添加项目</h4>
                </div>
                <div class="card-body">
                    <form action="{:url('index/project/save_project')}" method="post">
                        <div class="form-body">
                            <h3 class="card-title">客户信息</h3>
                            <hr>
                            <div class="row p-t-20">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="control-label">客户全称</label>
                                        <input type="text"  class="form-control customer_name" placeholder="请填写公司名称"  required autocomplete="off">
                                        <input type="hidden"  class="form-control"  name="customer_id" required >
                                        <small class="form-control-feedback"> </small>
                                    </div>
                                </div>
                                <div class="col-md-12" id="customer_display" style="color: red;" >

                                </div>
                                <script>
                                    $(".customer_name").bind('input propertychange', function () {
                                        var customer_name = $(this).val();
                                        if(!customer_name){
                                            $('#customer_display').html("请输入...");
                                        }
                                        else{
                                            $.ajax({
                                                url: "{:url('index/project/ajax_get_customer')}",
                                                data: {'customer_name':customer_name},
                                                method:"get",
                                                success:function(data){
                                                    if(data !=0){
                                                        var customer_html = "";

                                                        $.each(data,function(i,v){
                                                            var customer_id= v.id;
                                                            var customer_name= v.customer_name;

                                                            customer_html +="<div class='customer_div' onclick=\"send_customer('"+customer_id+"','"+customer_name+"');\" >"+customer_name+"</div>";
                                                        });

                                                        $('#customer_display').html(customer_html);
                                                    }
                                                    else{
                                                        $('#customer_display').html("没找到客户信息");
                                                    }
                                                },
                                                dataType: "json"
                                            });
                                        }

                                    });

                                    function send_customer(id,name) {
                                        $(".customer_name").val(name);
                                        $("input[name=customer_id]").val(id);
                                        $("#customer_display div").hide();
                                    }

                                    $("form").submit(function () {
                                        var customer_id = $("input[name=customer_id]").val();
                                        if(!customer_id){
                                            $("#customer_display").html("请填写正确的客户");
                                            return false;
                                        }
                                    });

                                </script>
                            </div>
                            <!--/row-->



                            <!--/row-->
                            <h3 class="box-title m-t-40">项目信息</h3>
                            <hr>
                            <div class="row">
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>项目所在部门</label>
                                        <select class="form-control custom-select department"  name="executor_department_id"  required>
                                            {volist name="departments" id="dep"}
                                                <option value="{$dep.id}">{$dep.department_name}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>项目执行人</label>
                                        <select class="form-control custom-select executor_department_id"   required name="executor_uid" >
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>策划部门</label>
                                        <select class="form-control custom-select department"   name="planning_department_id" required>
                                            {volist name="departments" id="dep"}
                                            <option value="{$dep.id}">{$dep.department_name}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>策划人</label>
                                        <select class="form-control custom-select planning_department_id"   required name="planning_uid">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>对接部门</label>
                                        <select class="form-control custom-select department"   name="docking_department_id" required>
                                            {volist name="departments" id="dep"}
                                            <option value="{$dep.id}">{$dep.department_name}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>对接人</label>
                                        <select class="form-control custom-select docking_department_id"   required name="docking_uid">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>管理部门</label>
                                        <select class="form-control custom-select department"   required name="manage_department_id">
                                            {volist name="departments" id="dep"}
                                            <option value="{$dep.id}">{$dep.department_name}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 ">
                                    <div class="form-group">
                                        <label>管理人</label>
                                        <select class="form-control custom-select manage_department_id"   name="manage_uid" required>
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                                <div class="col-md-6 ">
                                    <div class="form-group">
                                        <label>需求产品一级</label>
                                        <select class="form-control custom-select" name="product_demand_1" >
                                            {volist name="$data['product_demand']" id="product_demand" }
                                            <option value="{$product_demand}">{$product_demand}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 ">
                                    <div class="form-group">
                                        <label>需求产品二级</label>
                                        <select class="form-control custom-select"  name="product_demand_2">
                                            <option value="">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <!--/row-->
                            <h3 class="box-title m-t-40">合同信息</h3>
                            <hr>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>合同状态</label>
                                        <select class="form-control custom-select" required name="contract_status">
                                            {volist name="data['contract_status']" id="contract_status"}
                                                <option value="{$contract_status}">{$contract_status}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>合同金额</label>
                                        <input type="text"  class="form-control" placeholder="请输入合同金额" required name="contract_amount" >
                                        <small class="form-control-feedback"> </small>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>回款模式</label>
                                        <select class="form-control custom-select" required name="payment_type">
                                            {volist name="data['payment_type']" id="payment_type"}
                                            <option value="{$payment_type}">{$payment_type}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>回款状态</label>
                                        <select class="form-control custom-select" required name="payment_status">
                                            {volist name="data['payment_status']" id="payment_status"}
                                                <option value="{$payment_status}">{$payment_status}</option>
                                            {/volist}
                                        </select>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>毛利润率</label>
                                        <input type="text"  class="form-control" placeholder="请填写毛利润率" name="rate" required>
                                        <small class="form-control-feedback"> </small>
                                    </div>
                                </div>
                                <!--/span-->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>成本支出</label>
                                        <input type="text"  class="form-control" placeholder="请填写成本支出" name="cost" required>
                                        <small class="form-control-feedback"> </small>
                                    </div>
                                </div>
                                <!--/span-->
                            </div>
                            <div class="row">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success"> <i class="fa fa-check"></i> 保存</button>
                                <button type="reset" class="btn btn-inverse">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>

        //部门和负责人
        $(".department").each(function () {
            var name = $(this).attr("name");
            var department_id = $(this).val();
            //获取department_id下所有用户
            $.ajax({
                url: "{:url('index/project/ajax_get_user')}",
                data: {'department_id':department_id},
                method:"get",
                success:function(data){
                    //写入到对应位置
                    var option_html = "";
                    $.each(data,function(i,v){
                        option_html+="<option value='"+v.uid+"'>"+v.chinese_name+"</option>"
                    })
                    $('.'+ name +'').html(option_html);
                },
                dataType: "json"
            });
        });

        $(".department").change(function () {
            var name = $(this).attr("name");
            var department_id = $(this).val();
           //获取department_id下所有用户
            $.ajax({
                url: "{:url('index/project/ajax_get_user')}",
                data: {'department_id':department_id},
                method:"get",
                success:function(data){
                   //写入到对应位置
                    var option_html = "";
                    $.each(data,function(i,v){
                        option_html+="<option value='"+v.uid+"'>"+v.chinese_name+"</option>"
                    })
                    $('.'+ name +'').html(option_html);
                },
                dataType: "json"
            });

        });
        //产品需求二级
        var first_demand_1 =  $("select[name=product_demand_1]").val();
        $.ajax({
            url: "{:url('index/project/ajax_get_demand2')}",
            data: {'demand_value':first_demand_1},
            method:"get",
            success:function(data){
                //写入到对应位置
                var option_html = "";
                $.each(data,function(i,v){
                    option_html+="<option value='"+v+"'>"+v+"</option>"
                })
                $("select[name=product_demand_2]").html(option_html);
            },
            dataType: "json"
        });

        $("select[name=product_demand_1]").change(function(){
            var demand_value = $(this).val();
            $.ajax({
                url: "{:url('index/project/ajax_get_demand2')}",
                data: {'demand_value':demand_value},
                method:"get",
                success:function(data){
                    //写入到对应位置
                    var option_html = "";
                    $.each(data,function(i,v){
                        option_html+="<option value='"+v+"'>"+v+"</option>"
                    })
                    $("select[name=product_demand_2]").html(option_html);
                },
                dataType: "json"
            });
        });
    </script>
 {/block}
